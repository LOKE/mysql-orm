<!DOCTYPE html><html><!-- Built with spec-md --><head><meta charset="utf-8"><title>mysl-orm</title><link href="spec.css" rel="stylesheet"><link href="highlight.css" rel="stylesheet"></head><body><header><h1>mysl-orm</h1><section id="intro"><p><strong>Introduction</strong></p><p>A MYSQL model framework for Node.js based on the repository pattern.</p></section><div class="spec-toc"><ol><li><a href="#sec-Overview"><span class="spec-secid">1</span>Overview</a><ol><li><a href="#sec-Installation"><span class="spec-secid">1.1</span>Installation</a></li><li><a href="#sec-Example"><span class="spec-secid">1.2</span>Example</a></li></ol></li><li><a href="#sec-Connection"><span class="spec-secid">2</span>Connection</a></li><li><a href="#sec-Schema"><span class="spec-secid">3</span>Schema</a><ol><li><a href="#sec-Defining-Schemas"><span class="spec-secid">3.1</span>Defining Schemas</a></li><li><a href="#sec-Relations"><span class="spec-secid">3.2</span>Relations</a></li><li><a href="#sec-Types-"><span class="spec-secid">3.3</span>Types:</a></li></ol></li><li><a href="#sec-Repository"><span class="spec-secid">4</span>Repository</a><ol><li><a href="#sec-find"><span class="spec-secid">4.1</span>find</a></li><li><a href="#sec-stream"><span class="spec-secid">4.2</span>stream</a></li><li><a href="#sec-findOne"><span class="spec-secid">4.3</span>findOne</a></li><li><a href="#sec-findById"><span class="spec-secid">4.4</span>findById</a></li><li><a href="#sec-new"><span class="spec-secid">4.5</span>new</a></li><li><a href="#sec-persist"><span class="spec-secid">4.6</span>persist</a></li><li><a href="#sec-update"><span class="spec-secid">4.7</span>update</a></li><li><a href="#sec-create"><span class="spec-secid">4.8</span>create</a></li><li><a href="#sec-insert"><span class="spec-secid">4.9</span>insert</a></li><li><a href="#sec-reload"><span class="spec-secid">4.10</span>reload</a></li><li><a href="#sec-remove"><span class="spec-secid">4.11</span>remove</a></li><li><a href="#sec-delete"><span class="spec-secid">4.12</span>delete</a></li><li><a href="#sec-count"><span class="spec-secid">4.13</span>count</a></li><li><a href="#sec-updateWhere"><span class="spec-secid">4.14</span>updateWhere</a></li><li><a href="#sec-removeWhere"><span class="spec-secid">4.15</span>removeWhere</a></li><li><a href="#sec-literal"><span class="spec-secid">4.16</span>literal</a></li><li><a href="#sec-rawInsert"><span class="spec-secid">4.17</span>rawInsert</a></li><li><a href="#sec-rawSelect"><span class="spec-secid">4.18</span>rawSelect</a></li><li><a href="#sec-rawUpdate"><span class="spec-secid">4.19</span>rawUpdate</a></li><li><a href="#sec-didApplyChanges"><span class="spec-secid">4.20</span>didApplyChanges</a></li></ol></li><li><a href="#sec-Instances"><span class="spec-secid">5</span>Instances</a></li><li><a href="#sec-Testing"><span class="spec-secid">6</span>Testing</a></li><li><a href="#sec-Implementation"><span class="spec-secid">7</span>Implementation</a></li></ol></div></header><section id="sec-Overview"><h2><span class="spec-secid" title="link to this section"><a href="#sec-Overview">1</a></span>Overview</h2><section id="sec-Installation"><h3><span class="spec-secid" title="link to this section"><a href="#sec-Installation">1.1</a></span>Installation</h3><p><a href="https://www.npmjs.com/package/loke-mysql-orm"><img src="https://img.shields.io/npm/v/loke-mysql-orm.svg" alt="NPM Version"/></a></p><p>Install from <a href="https://npmjs.org">npm</a>:</p><p><code>npm install --save loke-mysql-orm</code></p></section><section id="sec-Example"><h3><span class="spec-secid" title="link to this section"><a href="#sec-Example">1.2</a></span>Example</h3><pre><code><span class="hljs-keyword">var</span> db = <span class="hljs-built_in">require</span>(<span class="hljs-string">'loke-mysql-orm'</span>).create(<span class="hljs-string">'mysql://root@localhost/demo'</span>);
<span class="hljs-keyword">var</span> petRepository = db.table(<span class="hljs-string">'Pets'</span>, {
  name: { type: <span class="hljs-built_in">String</span>, defaultValue: () =&gt; <span class="hljs-string">'Untitled'</span> },
  description: db.Text
});
<span class="hljs-keyword">var</span> userRepository = db.table(<span class="hljs-string">'Users'</span>, {
  firstName: db.String,
  lastName: db.String,
  pets: [petRepository]
});

userRepository.find({firstName: <span class="hljs-string">'Testing'</span>})
.then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">users</span>) </span>{
  users[<span class="hljs-number">0</span>].pets[<span class="hljs-number">0</span>].description = <span class="hljs-string">'Hello World!'</span>;
  <span class="hljs-keyword">return</span> userRepository.persist(users[<span class="hljs-number">0</span>]);
});
</code></pre></section></section><section id="sec-Connection"><h2><span class="spec-secid" title="link to this section"><a href="#sec-Connection">2</a></span>Connection</h2><p>Create a connection.</p><pre><code><span class="hljs-keyword">var</span> db = <span class="hljs-built_in">require</span>(<span class="hljs-string">'loke-mysql-orm'</span>).create(MYSQL_URI, {
  logging: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">sql</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'SQL: '</span> +  sql);
  }
});

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">finish</span>(<span class="hljs-params"></span>) </span>{
  db.end();
}
</code></pre></section><section id="sec-Schema"><h2><span class="spec-secid" title="link to this section"><a href="#sec-Schema">3</a></span>Schema</h2><p>Repositories allow you to query and update documents in the database.</p><p>To create a repository you first must define a schema to describe which columns and database tables to use.</p><section id="sec-Defining-Schemas"><h3><span class="spec-secid" title="link to this section"><a href="#sec-Defining-Schemas">3.1</a></span>Defining Schemas</h3><p>The <code>db.table</code> method allows creating repositories with a schema description.</p><pre><code><span class="hljs-comment">/**
 * Create a repository
 * @param  {String} tableName
 * @param  {} schemaDescription describe keys
 * @return {Repository} model constructor
 */</span>
Connection.prototype.table = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tableName, schemaDescription</span>) </span>{
  <span class="hljs-keyword">var</span> schema = <span class="hljs-keyword">new</span> Schema(schemaDescription);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SequelizeRepository(sequelize, tableName, schema);
};
</code></pre><p>Example Usage:</p><pre><code><span class="hljs-keyword">var</span> db = <span class="hljs-built_in">require</span>(<span class="hljs-string">'loke-mysql-orm'</span>).create(<span class="hljs-string">'mysql://root@localhost/demo'</span>);

<span class="hljs-keyword">var</span> userRepo = db.table(<span class="hljs-string">'Users'</span>, {
  firstName: {type: db.String},
  birthdate: {type: db.Date}
});
</code></pre></section><section id="sec-Relations"><h3><span class="spec-secid" title="link to this section"><a href="#sec-Relations">3.2</a></span>Relations</h3><p>Relations are defined by using another repository instance as a <code>type</code> value.</p><p>Example Usage:</p><pre><code><span class="hljs-keyword">var</span> db = <span class="hljs-built_in">require</span>(<span class="hljs-string">'loke-mysql-orm'</span>).create(<span class="hljs-string">'mysql://root@localhost/demo'</span>);

<span class="hljs-keyword">var</span> address  = db.table(<span class="hljs-string">'Addresses'</span>, { suburb : <span class="hljs-built_in">String</span> });
<span class="hljs-keyword">var</span> petsRepo = db.table(<span class="hljs-string">'Pets'</span>,      { name   : <span class="hljs-built_in">String</span> });

<span class="hljs-keyword">var</span> userRepo = db.table(<span class="hljs-string">'Users'</span>, {
  address  : { type: address },   <span class="hljs-comment">// Defines a `HasOne` relation</span>
  pets     : { type: [petsRepo] } <span class="hljs-comment">// Defines a `HasMany` relation</span>
});
</code></pre></section><section id="sec-Types-"><h3><span class="spec-secid" title="link to this section"><a href="#sec-Types-">3.3</a></span>Types:</h3><p>List of all supported types and their MYSQL translation:</p><ul><li><code>db.Id</code> - <code>INT(11) UNSIGNED</code></li><li><code>db.String</code> - <code>VARCHAR(255)</code></li><li><code>db.Number</code> - <code>DOUBLE</code></li><li><code>db.Boolean</code> - <code>TINYINT(1)</code></li><li><code>db.Date</code> - <code>DATETIME</code></li><li><code>db.Text</code> - <code>TEXT</code></li><li><code>db.Decimal</code> - <code>DECIMAL(10, 2)</code></li><li><code>db.Enum</code> - <code>ENUM</code> </li></ul></section></section><section id="sec-Repository"><h2><span class="spec-secid" title="link to this section"><a href="#sec-Repository">4</a></span>Repository</h2><p>All query methods defined on repositories return a <code>Promise</code>, using native promises if available, and otherwise falling back to using the <a href="https://www.npmjs.com/package/es6-promise"><code>es6-promise</code></a> library on NPM. If you want it to use a different promise implementation use the <code>require(&#x27;loke-mysql-orm&#x27;).setPromiseConstructor(Promise)</code> method.</p><section id="sec-find"><h3><span class="spec-secid" title="link to this section"><a href="#sec-find">4.1</a></span>find</h3><p>Query documents: <code>find(q, opts)</code>.</p><p>The first argument is the query description object which is passed to <em>Sequelize</em> as the <code>where</code> parameter. As such, it can contain operators like as <code>$or</code> and <code>$lte</code>. You can find a <a href="http://sequelize.readthedocs.org/en/latest/docs/querying/">full list of operators in the Sequelize documentation</a>.</p><p>Example:</p><pre><code>userRepo.find({added: {$lt: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2014'</span>)});
</code></pre><p>Options:</p><table><thead><tr><th>Option </th><th>Description </th></tr></thead><tbody><tr><td>opts.attributes </td><td>List of field names or Literal objects to select </td></tr><tr><td>opts.limit </td><td>Number of rows to return </td></tr><tr><td>opts.offset </td><td>Number of rows to skip </td></tr><tr><td>opts.order </td><td>Sort. E.g. <code>[[&#x27;ID&#x27;, &#x27;ASC&#x27;]]</code> </td></tr><tr><td>opts.raw </td><td>Whether to bypass casting </td></tr></tbody></table></section><section id="sec-stream"><h3><span class="spec-secid" title="link to this section"><a href="#sec-stream">4.2</a></span>stream</h3><p>Query documents using a streaming interface. Same function signature as <code>find()</code>, but returns a Readable stream.</p><pre><code>userRepo.find({added: {$lt: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2014'</span>)})
.on(<span class="hljs-string">'data'</span>, user =&gt; <span class="hljs-built_in">console</span>.log(user.firstName))
.on(<span class="hljs-string">'end'</span>, () =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'END'</span>));
</code></pre><p>Options:</p><table><thead><tr><th>Option </th><th>Description </th></tr></thead><tbody><tr><td>opts.highWaterMark </td><td>Maximum number of rows to pre&#8208;buffer in memory when there is a slow consumer </td></tr><tr><td>opts.attributes </td><td>List of field names or Literal objects to select </td></tr><tr><td>opts.limit </td><td>Number of rows to return </td></tr><tr><td>opts.offset </td><td>Number of rows to skip </td></tr><tr><td>opts.order </td><td>Sort. E.g. <code>[[&#x27;ID&#x27;, &#x27;ASC&#x27;]]</code> </td></tr><tr><td>opts.raw </td><td>Whether to bypass casting </td></tr></tbody></table></section><section id="sec-findOne"><h3><span class="spec-secid" title="link to this section"><a href="#sec-findOne">4.3</a></span>findOne</h3><p>Find the first document for a query.</p><pre><code>Repository.prototype.findOne = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">q, opts</span>) </span>{
  opts = opts || {};
  opts.limit = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.find(q, opts)
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">results</span>) </span>{
    <span class="hljs-keyword">return</span> results[<span class="hljs-number">0</span>] || <span class="hljs-literal">null</span>;
  });
};
</code></pre></section><section id="sec-findById"><h3><span class="spec-secid" title="link to this section"><a href="#sec-findById">4.4</a></span>findById</h3><p>Find a document by its primary key.</p><pre><code>Repository.prototype.findById = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, opts</span>) </span>{
  <span class="hljs-keyword">var</span> q = {};
  q[<span class="hljs-keyword">this</span>.schema.primaryField.name] = id;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.findOne(q, opts);
};
</code></pre></section><section id="sec-new"><h3><span class="spec-secid" title="link to this section"><a href="#sec-new">4.5</a></span>new</h3><p>Create a document without yet persisting it to the database.</p><p>Example:</p><pre><code><span class="hljs-keyword">var</span> user = userRepository.new({firstName: <span class="hljs-string">'Testing'</span>});
<span class="hljs-built_in">console</span>.log(user.firstName);
</code></pre></section><section id="sec-persist"><h3><span class="spec-secid" title="link to this section"><a href="#sec-persist">4.6</a></span>persist</h3><p>Save a document. Depending on whether the object is already in the database, this will trigger either an <code>INSERT</code> or an <code>UPDATE</code> query. Persisting a document will also persist all of its related child documents (HasOne and HasMany).</p><pre><code><span class="hljs-keyword">var</span> user = userRepository.new({firstName: <span class="hljs-string">'Testing'</span>});
userRepository.persist(user);
</code></pre></section><section id="sec-update"><h3><span class="spec-secid" title="link to this section"><a href="#sec-update">4.7</a></span>update</h3><p>Update a document by using its primary key.</p><pre><code>userRepository.update(user, {firstName: <span class="hljs-string">'ReplacementValue'</span>});
</code></pre></section><section id="sec-create"><h3><span class="spec-secid" title="link to this section"><a href="#sec-create">4.8</a></span>create</h3><p>Shorthand to build a document and persist it:</p><pre><code>Repository.prototype.create = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">o</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.persist(<span class="hljs-keyword">this</span>.new(o));
};
</code></pre></section><section id="sec-insert"><h3><span class="spec-secid" title="link to this section"><a href="#sec-insert">4.9</a></span>insert</h3><p>You would usually not use this directly, but use <code>persist()</code> instead. This inserts values into a table.</p><p>Example:</p><pre><code>userRepo.insert({x: <span class="hljs-number">3</span>, y: <span class="hljs-number">5</span>});
<span class="hljs-comment">// INSERT INTO `Users` (`ID`, `x`, `y`)</span>
<span class="hljs-comment">// VALUES (DEFAULT, 3, 5);</span>

</code></pre></section><section id="sec-reload"><h3><span class="spec-secid" title="link to this section"><a href="#sec-reload">4.10</a></span>reload</h3><p>Reload the entire document.</p><pre><code>exampleRepo.reload(<span class="hljs-built_in">document</span>);
</code></pre></section><section id="sec-remove"><h3><span class="spec-secid" title="link to this section"><a href="#sec-remove">4.11</a></span>remove</h3><p>Delete a document. Creates a <code>DELETE</code> query with the primary key.</p><p>Example:</p><pre><code>userRepo.remove(user);
</code></pre></section><section id="sec-delete"><h3><span class="spec-secid" title="link to this section"><a href="#sec-delete">4.12</a></span>delete</h3><p>Delete a document. By default, this will call .remove, but can be overridden to implement soft&#8208;deleting.</p><p>Example:</p><pre><code>userRepo.delete(user);
</code></pre></section><section id="sec-count"><h3><span class="spec-secid" title="link to this section"><a href="#sec-count">4.13</a></span>count</h3><p>Count the number of rows matching a query. Uses the <code>COUNT(*)</code> SQL method.</p><p>Example:</p><pre><code>userRepo.count({gender: <span class="hljs-string">'FEMALE'</span>})
.then(n =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`There are <span class="hljs-subst">${n}</span> female users.`</span>));
</code></pre></section><section id="sec-updateWhere"><h3><span class="spec-secid" title="link to this section"><a href="#sec-updateWhere">4.14</a></span>updateWhere</h3><p>Creates an <code>UPDATE</code> query. Returns a promise that resolves to the number of rows affected.</p><pre><code><span class="hljs-comment">// UPDATE Users SET y = 5 WHERE X = 3</span>
userRepo.updateWhere({x: <span class="hljs-number">3</span>}, {y: <span class="hljs-number">5</span>});
</code></pre></section><section id="sec-removeWhere"><h3><span class="spec-secid" title="link to this section"><a href="#sec-removeWhere">4.15</a></span>removeWhere</h3><p>Create a <code>DELETE</code> query. Example</p><pre><code><span class="hljs-comment">// DELETE FROM Users WHERE X = 3</span>
userRepo.deleteWhere({x: <span class="hljs-number">3</span>});
</code></pre></section><section id="sec-literal"><h3><span class="spec-secid" title="link to this section"><a href="#sec-literal">4.16</a></span>literal</h3><p>Create SQL code object Literal for use in <code>attributes</code> parameters. To avoid SQL injections the string should not contain user input.</p><p>Example:</p><pre><code>exampleRepo.find({}, {
  raw: <span class="hljs-literal">true</span>,
  attributes: [exampleRepo.literal(<span class="hljs-string">'COUNT(*) AS n'</span>)]
})
.then(row =&gt; {
  <span class="hljs-comment">// { n: 5 }</span>
  <span class="hljs-built_in">console</span>.log(row);
});
</code></pre></section><section id="sec-rawInsert"><h3><span class="spec-secid" title="link to this section"><a href="#sec-rawInsert">4.17</a></span>rawInsert</h3><p>Create a custom <code>INSERT</code> query. To avoid SQL injections the string should not contain user input.</p><p>Example:</p><p>rawSQLString:</p><pre><code><span class="hljs-operator"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> example (a,b,<span class="hljs-keyword">c</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>)
  <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DUPLICATE</span> <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">c</span>=<span class="hljs-keyword">c</span>+:<span class="hljs-keyword">value</span>;</span>
</code></pre><p>code:</p><pre><code>exampleRepo.rawInsert(rawSQLString, {value: <span class="hljs-number">1</span>});
</code></pre></section><section id="sec-rawSelect"><h3><span class="spec-secid" title="link to this section"><a href="#sec-rawSelect">4.18</a></span>rawSelect</h3><p>Create a custom <code>SELECT</code> query. To avoid SQL injections the string should not contain user input.</p><p>Example:</p><p>rawSQLString:</p><pre><code><span class="hljs-operator"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> example <span class="hljs-keyword">WHERE</span> a + b &lt; :<span class="hljs-keyword">value</span>
</span></code></pre><p>code:</p><pre><code>exampleRepo.rawSelect(rawSQLString, {value: <span class="hljs-number">300</span>});
</code></pre></section><section id="sec-rawUpdate"><h3><span class="spec-secid" title="link to this section"><a href="#sec-rawUpdate">4.19</a></span>rawUpdate</h3><p>Create a custom <code>UPDATE</code> query. Returns the number of affected rows. To avoid SQL injections the string should not contain user input.</p><p>Example:</p><p>rawIncrementString:</p><pre><code><span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> example <span class="hljs-keyword">SET</span> <span class="hljs-keyword">c</span> = <span class="hljs-keyword">c</span> + <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> a = :a <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
</span></code></pre><p>code:</p><pre><code>exampleRepo.rawUpdate(rawIncrementString, {a: <span class="hljs-number">239</span>});
</code></pre></section><section id="sec-didApplyChanges"><h3><span class="spec-secid" title="link to this section"><a href="#sec-didApplyChanges">4.20</a></span>didApplyChanges</h3><p>When you use the <code>repo.update(document, {...changes})</code> method the change tracking system will update the local <code>document</code> object. However, with custom SQL queries this cannot be done automatically.</p><p>Although it is possible to update the in&#8208;memory object simply by setting <code>document.c = document.c + 1</code>, that would cause problems if you were to persist that object later on.</p><p>Hence, to update the local value on the document, without triggering the change tracker to overwrite anything, there is a <code>didApplyChanges(document, fieldValues, relationValues)</code> method for this purpose.</p><p>Example:</p><p>rawIncrementString:</p><pre><code><span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> example <span class="hljs-keyword">SET</span> <span class="hljs-keyword">c</span> = <span class="hljs-keyword">c</span> + <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = :<span class="hljs-keyword">id</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
</span></code></pre><p>code:</p><pre><code>exampleRepo.rawUpdate(rawIncrementString, {id: <span class="hljs-built_in">document</span>.id})
.then(nUpdated =&gt; {
  <span class="hljs-keyword">if</span> (nUpdated) exampleRepo.didApplyChanges(<span class="hljs-built_in">document</span>, {c: <span class="hljs-built_in">document</span>.c + <span class="hljs-number">1</span>});
});
</code></pre></section></section><section id="sec-Instances"><h2><span class="spec-secid" title="link to this section"><a href="#sec-Instances">5</a></span>Instances</h2><p>To add instance methods, define them on the Repository#prototype property:</p><pre><code><span class="hljs-keyword">var</span> userRepository = db.table(<span class="hljs-string">'Users'</span>, {});

userRepository.prototype.getFullName = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.firstName + <span class="hljs-string">' '</span> + <span class="hljs-keyword">this</span>.lastName;
};
</code></pre></section><section id="sec-Testing"><h2><span class="spec-secid" title="link to this section"><a href="#sec-Testing">6</a></span>Testing</h2></section><section id="sec-Implementation"><h2><span class="spec-secid" title="link to this section"><a href="#sec-Implementation">7</a></span>Implementation</h2></section><footer>Written in <a href="http://leebyron.com/spec-md/" target="_blank">Spec Markdown</a>.</footer></body></html>